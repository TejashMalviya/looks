import os
import cv2
import numpy as np
from flask import Flask, render_template, request, jsonify
from werkzeug.utils import secure_filename
import random

# Initialize Flask app
app = Flask(__name__)

# Allowed file extensions
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg'}

# Set up file upload folder
UPLOAD_FOLDER = 'uploads'
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# Function to check if the uploaded file is an allowed image
def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

# Function to analyze image and give a funny reaction
def analyze_image(image_path):
    img = cv2.imread(image_path)
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

    # Load Haar Cascade for face detection
    face_cascade = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml')
    
    # Detect faces
    faces = face_cascade.detectMultiScale(gray, 1.1, 4)
    
    if len(faces) == 0:
        return "No face detected"

    # Simple aesthetic judgment with fun reactions
    reactions = [
        "Looking sharp!",
        "Is that a movie star?",
        "Charming smile, isn't it?",
        "Chikna vibes! ðŸ˜Ž",
        "Looking like a Bollywood hero!",
        "You sure you don't belong on a magazine cover?",
        "Sizzling hot looks!",
        "Superstar energy!"
    ]
    
    return random.choice(reactions)

# Route to serve the upload page
@app.route('/')
def index():
    return '''
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI Photo Comparison - Who Looks Better?</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f0f8ff;
                margin: 0;
                padding: 0;
                text-align: center;
            }

            h1 {
                color: #3498db;
                font-size: 2.5em;
                margin-top: 20px;
            }

            input[type="file"] {
                margin: 10px;
                font-size: 1.2em;
            }

            #upload-btn {
                padding: 15px 25px;
                background-color: #3498db;
                color: white;
                border: none;
                font-size: 1.2em;
                cursor: pointer;
            }

            #upload-btn:hover {
                background-color: #2980b9;
            }

            #result {
                margin-top: 40px;
                display: none;
            }

            #loading {
                display: none;
                font-size: 1.5em;
                color: #e74c3c;
            }
        </style>
    </head>
    <body>

    <h1>AI Photo Comparison: Who's Got the Best Look?</h1>

    <div>
        <input type="file" id="photo1" accept="image/*">
        <input type="file" id="photo2" accept="image/*">
        <br><br>
        <button id="upload-btn" onclick="uploadPhotos()">Upload and Compare</button>
    </div>

    <div id="loading">Analyzing photos...</div>

    <div id="result">
        <h2 id="winner"></h2>
        <p id="feedback"></p>
        <p><strong>Photo 1 result:</strong> <span id="result1"></span></p>
        <p><strong>Photo 2 result:</strong> <span id="result2"></span></p>
    </div>

    <script>
        function uploadPhotos() {
            const file1 = document.getElementById('photo1').files[0];
            const file2 = document.getElementById('photo2').files[0];

            if (!file1 || !file2) {
                alert('Please upload two photos.');
                return;
            }

            const formData = new FormData();
            formData.append('file1', file1);
            formData.append('file2', file2);

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('result').style.display = 'block';
                document.getElementById('winner').textContent = data.winner;
                document.getElementById('feedback').textContent = data.feedback;
                document.getElementById('result1').textContent = data.image1_result;
                document.getElementById('result2').textContent = data.image2_result;
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                alert('Error uploading images.');
            });
        }
    </script>

    </body>
    </html>
    '''

# Route to handle the photo upload and analysis
@app.route('/upload', methods=['POST'])
def upload_image():
    if 'file1' not in request.files or 'file2' not in request.files:
        return jsonify({'error': 'No file part'}), 400

    file1 = request.files['file1']
    file2 = request.files['file2']

    if file1 and allowed_file(file1.filename) and file2 and allowed_file(file2.filename):
        filename1 = secure_filename(file1.filename)
        filename2 = secure_filename(file2.filename)

        filepath1 = os.path.join(app.config['UPLOAD_FOLDER'], filename1)
        filepath2 = os.path.join(app.config['UPLOAD_FOLDER'], filename2)

        file1.save(filepath1)
        file2.save(filepath2)

        # Analyze both images
        result1 = analyze_image(filepath1)
        result2 = analyze_image(filepath2)

        # Compare the results (simplified logic)
        winner = "Photo 1" if random.choice([True, False]) else "Photo 2"
        feedback = f"Looking great! The winner is: {winner}."

        # Return the result and feedback
        return jsonify({
            'winner': winner,
            'feedback': feedback,
            'image1_result': result1,
            'image2_result': result2
        })

    return jsonify({'error': 'Invalid file format'}), 400

if __name__ == '__main__':
    app.run(debug=True)
